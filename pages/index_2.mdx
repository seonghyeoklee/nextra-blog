![](https://images.velog.io/images/shlee327/post/fbdda8ff-b104-442c-a143-4f0260e1288e/image.png)

### ê°œìš”
`Spring boot + JPA` ì¡°í•©ì˜ í”„ë¡œì íŠ¸ë¥¼ ê³µë¶€í•˜ê³  ìˆë‹¤. ë³µì¡í•œ í”„ë¡œì íŠ¸ í™˜ê²½ì—ì„œ JPAì˜ í•œê³„ì ì„ ê·¹ë³µí•˜ê¸° ìœ„í•˜ì—¬ `querydsl`ì„ í•™ìŠµí•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤. ë³µì¡í•œ ì¿¼ë¦¬ì™€ ë™ì ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê¸°ì—ëŠ” `querydsl`ì´ ì í•©í•œ ê¸°ìˆ ì´ë¼ê³  ìƒê°í–ˆë‹¤. JPAì—ì„œ ì§€ì›í•˜ëŠ” JPQLë³´ë‹¤ ë” ì§ê´€ì ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì»´íŒŒì¼ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ í° ì¥ì ì´ë¼ ìƒê°í–ˆë‹¤. ëª¨ë“  sql ë¬¸ë²•ì„ ìë°” ì½”ë“œë¡œ ì§€ì›í•˜ê³  ìˆê³  ì½”ë“œ ì–´ì”¨ìŠ¤í„´ìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤. ë‹¤ì–‘í•œ ì¥ì ì´ ìˆì§€ë§Œ ê·¸ë§Œí¼ ëŸ¬ë‹ì»¤ë¸Œê°€ ìˆë‹¤ê³  ìƒê°í•œë‹¤. ê¸°ë³¸ì ì¸ ì‚¬ìš©ë°©ë²•ê³¼ ê¸°ë³¸ë¬¸ë²•ì„ ì‚¬ìš©í•˜ë©° ë‚´ìš©ì„ ì •ë¦¬í•˜ë ¤ê³  í•œë‹¤.

> ì¶œì²˜ - [ì‹¤ì „! Querydsl](https://www.inflearn.com/course/Querydsl-%EC%8B%A4%EC%A0%84/dashboard)



# í”„ë¡œì íŠ¸ ìƒì„±

ìŠ¤í”„ë§ ë¶€íŠ¸ ìŠ¤íƒ€í„°

[Spring Initializr](https://start.spring.io/)

### í”„ë¡œì íŠ¸ ìŠ¤í™

- Project `Gradle Project`
- Language `Java`
- `Spring boot 2.6.2`
- Packaging `Jar`
- `Java 11`
- **Dependencies**

  `Spring Web`

  `Spring Data JPA`

  `H2 Database`

  `Lombok`


# Querydsl ì„¤ì •ê³¼ ê²€ì¦

### ìŠ¤í”„ë§ ë¶€íŠ¸ 2.6 ì´ìƒ, Querydsl 5.0 ì§€ì› ë°©ë²•

ìµœê·¼ `ìŠ¤í”„ë§ ë¶€íŠ¸ 2.6` ì´ìƒ ë²„ì „ì—ì„œëŠ” `Querydsl 5.0`ì„ ì‚¬ìš©í•œë‹¤. ë³€ê²½ëœ ì‚¬í•­ì— ë”°ë¼ `build.gradle` ì„¤ì •ì„ ë³€ê²½í•´ì•¼ í•œë‹¤.

- `querydsl-jpa`, `querydsl-apt` ë¥¼ ì¶”ê°€í•˜ê³  ë²„ì „ì„ ëª…ì‹œí•´ì•¼ í•œë‹¤.
- ë³€ê²½ì‚¬í•­
    - **PageableExecutionUtils í´ë˜ìŠ¤ ì‚¬ìš© íŒ¨í‚¤ì§€ ë³€ê²½**
        - ê¸°ëŠ¥ì´ Deprecated ëœ ê²ƒì€ ì•„ë‹ˆê³ , ì‚¬ìš© íŒ¨í‚¤ì§€ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì—ˆë‹¤. ê¸°ì¡´ ìœ„ì¹˜ë¥¼ ì‹ ê·œ ìœ„ì¹˜ë¡œ
          ë³€ê²½í•˜ë©´ ë¬¸ì œ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - **Querydsl fetchResults(), fetchCount() Deprecated(í–¥í›„ ë¯¸ì§€ì›)**
        - Querydslì€ í–¥í›„ fetchCount() , fetchResult() ë¥¼ ì§€ì›í•˜ì§€ ì•Šê¸°ë¡œ ê²°ì •í–ˆë‹¤.

```java
buildscript {
	ext {
		queryDslVersion = "5.0.0"
	}
}

plugins {
	id 'org.springframework.boot' version '2.6.2'
	id 'io.spring.dependency-management' version '1.0.11.RELEASE'
	//querydsl ì¶”ê°€
	id "com.ewerk.gradle.plugins.querydsl" version "1.0.10"
	id 'java'
}

group = 'study'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-web'

	//querydsl ì¶”ê°€
	implementation "com.querydsl:querydsl-jpa:${queryDslVersion}"
	annotationProcessor "com.querydsl:querydsl-apt:${queryDslVersion}"

	compileOnly 'org.projectlombok:lombok'
	runtimeOnly 'com.h2database:h2'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

test {
	useJUnitPlatform()
}

//querydsl ì¶”ê°€ ì‹œì‘
def querydslDir = "$buildDir/generated/querydsl"

querydsl {
	jpa = true
	querydslSourcesDir = querydslDir
}

sourceSets {
	main.java.srcDir querydslDir
}

configurations {
	querydsl.extendsFrom compileClasspath
}

compileQuerydsl {
	options.annotationProcessorPath = configurations.querydsl
}
```

gradle ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆë‹¤ë©´

- `Gradle` - `Tasks` - `other` - `compileQuerydsl`
- `./gradlew clean compileQuerydsl`

ì‹¤í–‰í•˜ì—¬ `Querydsl query type`ì„ ìƒì„±í•œë‹¤. ìƒì„±ëœ ê²ƒì„ ë³´ë©´ Q~ ë¼ê³  ìë™ìœ¼ë¡œ ìƒì„±ëœ í´ë˜ìŠ¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í´ë˜ìŠ¤ ìƒì„±ì´ ë˜ì§€ ì•Šì•˜ë‹¤ë©´ `build.gradle` íŒŒì¼ì„ ë‹¤ì‹œ ì‚´í´ë³´ì.

*~~íŒŒì¼ ë‚´ìš©ì„ ì‚´í´ë´ë„  ì•„ì§ ì´í•´ê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤.~~*

ğŸ’¡ Qíƒ€ì…ì€ ì»´íŒŒì¼ ì‹œì ì— ìë™ ìƒì„±ë˜ë¯€ë¡œ ë²„ì „ê´€ë¦¬(git)ì— í¬í•¨í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤. ì•ì„œ ì„¤ì •ì—ì„œ ìƒì„± ìœ„ì¹˜ë¥¼ gradle build í´ë” ì•„ë˜ ìƒì„±ë˜ë„ë¡ í–ˆê¸° ë•Œë¬¸ì— ì´ ë¶€ë¶„ë„ ìì—°ìŠ¤ëŸ½ê²Œ í•´ê²°ëœë‹¤. (ëŒ€ë¶€ë¶„ gradle build í´ë”ë¥¼ gitì— í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.)

ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ì‚´í´ë³´ì. Qíƒ€ì… ê°ì²´ë¥¼ ì´ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•œ ëª¨ìŠµì´ë‹¤.

`selectFrom(qHello)` Qíƒ€ì… ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ `fetchOne` í•˜ë‚˜ì˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ëª¨ìŠµì´ë‹¤. `JPA`ëŠ” ê°ì²´ì˜ `ë™ì¼ì„±(identity)`ì„ ë³´ì¥í•œë‹¤. ë”°ë¼ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ê³  ìˆë˜ `Hello`ëŠ” ì¡°íšŒëœ ê²°ê³¼ì™€ ë™ì¼í•˜ë‹¤.

### Test ì‹¤í–‰ ë° ê²€ì¦

```java
@Test
void contextLoads() {
	Hello hello = new Hello();
	em.persist(hello);

	JPAQueryFactory query = new JPAQueryFactory(em);
	QHello qHello = new QHello("h");

	Hello result = query
			.selectFrom(qHello)
			.fetchOne();

	assertThat(result).isEqualTo(hello);
	assertThat(result.getId()).isEqualTo(hello.getId());
}
```

# **H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜**

ê°œë°œì´ë‚˜ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ê°€ë³ê³  í¸ë¦¬í•œ DB, ì›¹ í™”ë©´ ì œê³µí•œë‹¤.

[H2 Database Engine](https://www.h2database.com)

ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ê³  íŒŒì¼ì„ ì‹¤í–‰í•œë‹¤.

ğŸ’¡ ê¶Œí•œë•Œë¬¸ì— ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì‹¤í–‰íŒŒì¼ ìœ„ì¹˜ì—ì„œ `chmod 755 h2.sh`


- `jdbc:h2:~/querydsl` ìµœì´ˆ í•œë²ˆ ì‹¤í–‰í•œë‹¤.
- `~/querydsl.mv.db` ìƒì„± í™•ì¸
- ì´í›„ ë¶€í„°ëŠ” `jdbc:h2:tcp://localhost/~/querydsl` ì´ë ‡ê²Œ ì ‘ì†í•œë‹¤.

# **ìŠ¤í”„ë§ ë¶€íŠ¸ ì„¤ì • JPA, DB**

`application.yml` íŒŒì¼ ìƒì„±

```yaml
spring:
  datasource:
    url: jdbc:h2:tcp://localhost/~/querydsl
    username: sa
    password:
    driver-class-name: org.h2.Driver

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
				format_sql: true

logging.level:
  org.hibernate.SQL: debug
```

- `ddl-auto: create`
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— í…Œì´ë¸”ì„ drop í•˜ê³ , ë‹¤ì‹œ ìƒì„±í•œë‹¤.


ğŸ’¡ `org.hibernate.SQL` ì˜µì…˜ì€ loggerë¥¼ í†µí•´ í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.
í•˜ì§€ë§Œ `show_sql` ì˜µì…˜ì€ System.out ì— í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.
ë”°ë¼ì„œ `org.hibernate.SQL` ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤.

### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¡œê·¸ ë‚¨ê¸°ê¸°**

[GitHub - gavlyukovskiy/spring-boot-data-source-decorator: Spring Boot integration with p6spy, datasource-proxy, flexy-pool and spring-cloud-sleuth](https://github.com/gavlyukovskiy/spring-boot-data-source-decorator)

```yaml
implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.5.8â€™
```

- ë¡œê·¸ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ê¸° org.hibernate.type : SQL ì‹¤í–‰ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸´ë‹¤.


ğŸ’¡ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì‹œìŠ¤í…œ ìì›ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” í¸í•˜ê²Œ ì‚¬ìš©í•´ë„ ëœë‹¤. í•˜ì§€ë§Œ ìš´ì˜ì‹œìŠ¤í…œì— ì ìš©í•˜ë ¤ë©´ ê¼­ ì„±ëŠ¥í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.


# ë„ë©”ì¸ ëª¨ë¸ ì„¤ê³„

í•™ìŠµì— ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ì€ ë§¤ìš° ë‹¨ìˆœí•˜ë‹¤. `Member`, `Team` ë‘ ì—”í‹°í‹°ë¥¼ ì—°ê´€ê´€ê³„ë¥¼ ë§ºì–´ `querydsl`ì„ í•™ìŠµí•´ê² ë‹¤.

- `Member`

```java
    @Entity
    @Getter @Setter
    @NoArgsConstructor(access = AccessLevel.PROTECTED)
    @ToString(of = {"id", "username", "age"})
    public class Member {

        @Id @GeneratedValue
        @Column(name = "member_id")
        private Long id;

        private String username;

        private int age;

        @ManyToOne(fetch = FetchType.LAZY)
        @JoinColumn(name = "team_id")
        private Team team;

    }
```


- `Team`

```java
    @Entity
    @Getter @Setter
    @NoArgsConstructor(access = AccessLevel.PROTECTED)
    @ToString(of = {"id", "name"})
    public class Team {
    
        @Id @GeneratedValue
        @Column(name = "team_id")
        private Long id;
    
        private String name;
    
        @OneToMany(mappedBy = "team")
        private List<Member> members = new ArrayList<>();
    
        public Team(String name) {
            this.name = name;
        }
    
    }
```

ë©¤ë²„ì™€ íŒ€ì€ ì—°ê´€ê´€ê³„ë¥¼ ê°€ì§€ê³  ìˆë‹¤. ë©¤ë²„ëŠ” í•˜ë‚˜ì˜ íŒ€ì„ ê°€ì§€ê³  ìˆë‹¤. í•˜ë‚˜ì˜ íŒ€ì—ëŠ” ì—¬ëŸ¬ ë©¤ë²„ë¥¼ ê°€ì§€ê³  ìˆì„ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ `@ManyToOne`, `@OneToMany` ìœ¼ë¡œ ì—°ê´€ê´€ê³„ë¥¼ ì„¤ì •í•˜ê³  `FetchType.LAZY` ì§€ì—°ë¡œë”© ì„¤ì •ì„ ë³€ê²½í–ˆë‹¤. `FetchType.EAGER` ì¦‰ì‹œë¡œë”©ì€ ì¿¼ë¦¬ì˜ ì¡°ì¸ì´ ë°œìƒí•˜ë©´ N+1 ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆê³  ë¶ˆí•„ìš”í•œ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ëª¨ë“  ì„¤ì •ì€ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì²˜ë¦¬í•  ê²ƒì´ë‹¤.

## JPQA vs Querydsl

í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ Querydslì„ ì‚¬ìš©í•˜ëŠ” ê°„ë‹¨í•œ ë°©ë²•ê³¼ ì´ìœ ë¥¼ ì‚´í´ë³´ê² ë‹¤. ë¨¼ì € `JPQL`ì„ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë‹¤.

```java
@Test
void startJPQL() {
  Member findByJPQL = em.createQuery(
                  "select m from Member m " +
                          "where m.username = :username", Member.class)
          .setParameter("username", "member1")
          .getSingleResult();

	assertThat(findByJPQL.getUsername()).isEqualTo("member1");
}
```

`username` ì´ ì¼ì¹˜í•˜ëŠ” ë©¤ë²„ë¥¼ ì¡°íšŒí•˜ê³  ìˆë‹¤. ì—¬ê¸°ì„œ ì œì¼ ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì´ ë¬´ì—‡ì¼ê¹Œ? `JPQL`ì„ ì‘ì„±í•˜ë ¤ë©´ ë¬¸ìì—´ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤. ë¬¸ìì—´ì€ ì»´íŒŒì¼ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ì—†ë‹¤. ì‚¬ì†Œí•œ ë„ì–´ì“°ê¸°ë¡œ ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ì‹¤ì œë¡œ ì½”ë“œê°€ ë™ì‘í•˜ëŠ” ìˆœê°„ê¹Œì§€ ì—ëŸ¬ë¥¼ ë°œê²¬í•  ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤. ê°œë°œì ì…ì¥ì—ì„œëŠ” ì»´íŒŒì¼ ë‹¨ê³„ì—ì„œ ì—ëŸ¬ë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤ë©´ ì •ë§ì •ë§ ì¢‹ì„í…ë° ë§ì´ë‹¤. ë¬¼ë¡  í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í†µí•´ ê²¬ê³ í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ê·¸ëŸ¼ `Querydsl` í…ŒìŠ¤íŠ¸ë¥¼ ì‚´í´ë³´ì.

```java
@Test
void startQuerydsl() {
  QMember m = new QMember("m");

  Member findMember = jpaQueryFactory
          .select(m)
          .from(m)
          .where(m.username.eq("member1"))
          .fetchOne();

	assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

ë™ì¼í•œ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë‹¤. `Querydsl`ì€ ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ìë°”ì½”ë“œë¡œ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. ì´ëŠ” ì¿¼ë¦¬ë¥¼ ìë°” ì»´íŒŒì¼ëŸ¬ê°€ ê²€ì¦í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.


ğŸ’¡ `JPAQueryFactory`ë¥¼ í•„ë“œë¡œ ì œê³µí•˜ë©´ ë™ì‹œì„± ë¬¸ì œëŠ” ì–´ë–»ê²Œ ë ê¹Œ? ë™ì‹œì„± ë¬¸ì œëŠ” `JPAQueryFactory`ë¥¼ ìƒì„±í•  ë•Œ ì œê³µí•˜ëŠ” `EntityManager(em)`ì— ë‹¬ë ¤ìˆë‹¤. ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œì—ì„œ ë™ì‹œì— ê°™ì€ `EntityManager`ì— ì ‘ê·¼í•´ë„, íŠ¸ëœì­ì…˜ ë§ˆë‹¤ ë³„ë„ì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ê¸° ë•Œë¬¸ì—, ë™ì‹œì„± ë¬¸ì œëŠ” ê±±ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

## **ê¸°ë³¸ Q-Type í™œìš©**

### **Qí´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” 2ê°€ì§€ ë°©ë²•**

```java
QMember qMember = new QMember("m"); //ë³„ì¹­ ì§ì ‘ ì§€ì •
QMember qMember = QMember.member; //ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
```

í•˜ì§€ë§Œ ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ static importì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

### Querydslì—ì„œ ì‚¬ìš©ë˜ëŠ” JPQLì´ ê¶ê¸ˆí•  ë•Œ?


ğŸ’¡ spring.jpa.properties.hibernate.use_sql_comments: true

## ê²€ìƒ‰ì¡°ê±´ ì¿¼ë¦¬

```java
@Test
void search() {
  Member findMember = jpaQueryFactory
          .selectFrom(member)
          .where(member.username.eq("member1")
                  .and(member.age.eq(10)))
          .fetchOne();

	assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

ê²€ìƒ‰ì¡°ê±´ì€ ë©”ì„œë“œ ì²´ì¸ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ìˆê³  ëª¨ë“  ê²€ìƒ‰ ì¡°ê±´ì„ ì œê³µí•˜ê³  ìˆë‹¤.


## **AND ì¡°ê±´ì„ íŒŒë¼ë¯¸í„°ë¡œ ì²˜ë¦¬**

```java
@Test
void searchAndParam() {
  Member findMember = jpaQueryFactory
            .selectFrom(member)
            .where(
                member.username.eq("member1"),
                member.age.eq(10)
            )
            .fetchOne();
	
	assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

`where()` ì— íŒŒë¼ë¯¸í„°ë¡œ ê²€ìƒ‰ì¡°ê±´ì„ ì¶”ê°€í•˜ë©´ `AND` ì¡°ê±´ì´ ì¶”ê°€ëœë‹¤. ì´ê²½ìš° null ê°’ì€ ë¬´ì‹œí•œë‹¤.

## **ê²°ê³¼ ì¡°íšŒ**

- `fetch` : ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ, ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
- `fetchOne` : ë‹¨ ê±´ ì¡°íšŒ
    - ê²°ê³¼ê°€ ì—†ìœ¼ë©´ : null
    - ê²°ê³¼ê°€ ë‘˜ ì´ìƒì´ë©´ : `com.querydsl.core.NonUniqueResultException`
- `fetchFirst` : limit(1).fetchOne()
~~- `fetchResults` : í˜ì´ì§• ì •ë³´ í¬í•¨, total count ì¿¼ë¦¬ ì¶”ê°€ ì‹¤í–‰~~
~~- `fetchCount` : count ì¿¼ë¦¬ë¡œ ë³€ê²½í•´ì„œ count ìˆ˜ ì¡°íšŒ~~
_group by having ì¹´ìš´íŒ…ì—ì„œ í•´ë‹¹ ë©”ì†Œë“œê°€ ëª…í™•í•˜ê²Œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ì´ìŠˆê°€ ë°œìƒí•˜ì—¬ deprecated ì²˜ë¦¬ / 2022.08.14 ìˆ˜ì •_

## ì •ë ¬

- `desc()`, `asc()` : ì¼ë°˜ ì •ë ¬
- `nullsLast()`, `nullsFirst()` : null ë°ì´í„° ìˆœì„œ ë¶€ì—¬

## í˜ì´ì§•

ì‹¤ë¬´ì—ì„œ í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ë•Œ, ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ëŠ” ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ì§€ë§Œ, count ì¿¼ë¦¬ëŠ” ì¡°ì¸ì´ í•„ìš” ì—†ëŠ” ê²½ìš°ë„ ìˆë‹¤. ê·¸ëŸ°ë° ì´ë ‡ê²Œ ìë™í™”ëœ count ì¿¼ë¦¬ëŠ” ì›ë³¸ ì¿¼ë¦¬ì™€ ê°™ì´ ëª¨ë‘ ì¡°ì¸ì„ í•´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì•ˆë‚˜ì˜¬ ìˆ˜ ìˆë‹¤. count ì¿¼ë¦¬ì— ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•˜ë‹¤ë©´, count ì „ìš© ì¿¼ë¦¬ë¥¼ ë³„ë„ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤.

## **ì§‘í•©**

```java
@Test
void aggregation() {
    List<Tuple> result = queryFactory
        .select(member.count(),
                member.age.sum(),
                member.age.avg(),
                member.age.max(),
                member.age.min())
        .from(member)
        .fetch();
	
    Tuple tuple = result.get(0);
    assertThat(tuple.get(member.age.sum())).isEqualTo(100);
    assertThat(tuple.get(member.age.avg())).isEqualTo(25);
    assertThat(tuple.get(member.age.max())).isEqualTo(40);
}
```

## **ì¡°ì¸ ê¸°ë³¸ ì¡°ì¸**

### **ê¸°ë³¸ ì¡°ì¸**

ì¡°ì¸ì˜ ê¸°ë³¸ ë¬¸ë²•ì€ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì¡°ì¸ ëŒ€ìƒì„ ì§€ì •í•˜ê³ , ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ë³„ì¹­(alias)ìœ¼ë¡œ ì‚¬ìš©í•  Q íƒ€ì…ì„ ì§€ì •í•˜ë©´ ëœë‹¤.

- join(ì¡°ì¸ ëŒ€ìƒ, ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•  Qíƒ€ì…)

```java
@Test
void join() {
  List<Member> result = queryFactory
          .selectFrom(member)
          .join(member.team,team)
          .where(team.name.eq("teamA"))
          .fetch();

	assertThat(result)
            .extracting("username")
            .containsExactly("member1", "member2");
}
```

- `join()` , `innerJoin()` : ë‚´ë¶€ ì¡°ì¸(inner join)
- `leftJoin()` : left ì™¸ë¶€ ì¡°ì¸(left outer join)
- `rightJoin()` : rigth ì™¸ë¶€ ì¡°ì¸(rigth outer join)
- `JPQL`ì˜ `on`ê³¼ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ `fetch` ì¡°ì¸ ì œê³µ

### **ì„¸íƒ€ ì¡°ì¸**

ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” í•„ë“œë¡œ ì¡°ì¸í•œë‹¤.

```java
@Test
void theta_join() {
  em.persist(new Member("teamA"));
  em.persist(new Member("teamB"));

  List<Member> result = queryFactory
          .select(member)
          .from(member,team)
          .where(member.username.eq(team.name))
          .fetch();

	assertThat(result)
            .extracting("username")
            .containsExactly("teamA", "teamB");
}
```

- `from`ì ˆì— ì—¬ëŸ¬ ì—”í‹°í‹°ë¥¼ ì„ íƒí•´ì„œ ì„¸íƒ€ ì¡°ì¸
- ì™¸ë¶€ ì¡°ì¸ ë¶ˆê°€ëŠ¥ ë‹¤ìŒì— ì„¤ëª…í•  ì¡°ì¸ `on`ì„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ ì¡°ì¸ ê°€ëŠ¥

## **ì¡°ì¸ onì ˆ**

- ONì ˆì„ í™œìš©í•œ ì¡°ì¸(JPA 2.1ë¶€í„° ì§€ì›)
    - ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§

```java
        @Test
        void join_on_filtering() {
            List<Tuple> result = queryFactory
                    .select(member,team)
                    .from(member)
                    .leftJoin(member.team,team).on(team.name.eq("teamA"))
                    .fetch();
        
            for (Tuple tuple : result) {
                System.out.println("tuple = " + tuple);
            }
        }
```
    
- ì—°ê´€ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ì¡°ì¸

```java
        @Test
        void join_on_no_relation() {
            em.persist(new Member("teamA"));
            em.persist(new Member("teamB"));
            em.persist(new Member("teamC"));
        
            List<Tuple> result = queryFactory
                    .select(member,team)
                    .from(member)
                    .leftJoin(team).on(member.username.eq(team.name))
                    .fetch();
        
            for (Tuple tuple : result) {
                System.out.println("tuple = " + tuple);
            }
        }
```


- í•˜ì´ë²„ë„¤ì´íŠ¸ 5.1ë¶€í„° on ì„ ì‚¬ìš©í•´ì„œ ì„œë¡œ ê´€ê³„ê°€ ì—†ëŠ” í•„ë“œë¡œ ì™¸ë¶€ ì¡°ì¸í•˜ëŠ” ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆë‹¤.
- ë¬¸ë²•ì„ ì˜ ë´ì•¼ í•œë‹¤. `leftJoin()` ë¶€ë¶„ì— ì¼ë°˜ ì¡°ì¸ê³¼ ë‹¤ë¥´ê²Œ ì—”í‹°í‹° í•˜ë‚˜ë§Œ ë“¤ì–´ê°„ë‹¤.
  - ì¼ë°˜ì¡°ì¸: leftJoin(member.team, team)
  - onì¡°ì¸: from(member).leftJoin(team).on(xxx)

## **ì¡°ì¸ í˜ì¹˜ ì¡°ì¸**

SQLì¡°ì¸ì„ í™œìš©í•´ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. ì£¼ë¡œ ì„±ëŠ¥ ìµœì í™”ì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.

```java
@Test
void fetchJoinUse() {
    em.flush();
    em.clear();

    Member findMember = queryFactory
            .selectFrom(member)
            .join(member.team,team).fetchJoin()
            .where(member.username.eq("member1"))
            .fetchOne();

    boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam());
		assertThat(loaded).as("í˜ì¹˜ ì¡°ì¸ ì ìš©").isTrue();
}
```

- ì¦‰ì‹œë¡œë”©ìœ¼ë¡œ Member, Team SQL ì¿¼ë¦¬ ì¡°ì¸ìœ¼ë¡œ í•œë²ˆì— ì¡°íšŒí•œë‹¤.
- `join()`, `leftJoin()` ë“± ì¡°ì¸ ê¸°ëŠ¥ ë’¤ì— `fetchJoin()` ì´ë¼ê³  ì¶”ê°€í•˜ë©´ ëœë‹¤.

## **ì„œë¸Œ ì¿¼ë¦¬**

```java
@Test
void subQuery() {
    QMember memberSub = new QMember("memberSub");

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.eq(
                    JPAExpressions
                            .select(memberSub.age.max())
                            .from(memberSub)
            ))
            .fetch();

		assertThat(result)
            .extracting("age")
            .containsExactly(40);
}
```

```java
@Test
void subQueryGoe() {
    QMember memberSub = new QMember("memberSub");

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.goe(
                    JPAExpressions
                            .select(memberSub.age.avg())
                            .from(memberSub)
            ))
            .fetch();

		assertThat(result)
		            .extracting("age")
		            .containsExactly(30, 40);
}
```

```java
@Test
void subQueryIn() {
    QMember memberSub = new QMember("memberSub");

    List<Member> result = queryFactory
            .selectFrom(member)
            .where(member.age.in(
                    JPAExpressions
                            .select(memberSub.age)
                            .from(memberSub)
                            .where(memberSub.age.gt(10))
            ))
            .fetch();

		assertThat(result)
		            .extracting("age")
		            .containsExactly(20, 30, 40);
}
```

```java
@Test
void selectSubQuery() {
    QMember memberSub = new QMember("memberSub");

    List<Tuple> result = queryFactory
            .select(member.username,
                    JPAExpressions
                            .select(memberSub.age.avg())
                            .from(memberSub)
            )
            .from(member)
            .fetch();

    for (Tuple tuple : result) {
        System.out.println("tuple = " + tuple);
    }
}
```


ğŸ’¡ JPA JPQL ì„œë¸Œì¿¼ë¦¬ì˜ í•œê³„ì ìœ¼ë¡œ from ì ˆì˜ ì„œë¸Œì¿¼ë¦¬(ì¸ë¼ì¸ ë·°)ëŠ” ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. ë‹¹ì—°íˆ Querydsl ë„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ select ì ˆì˜ ì„œë¸Œì¿¼ë¦¬ëŠ” ì§€ì›í•œë‹¤. Querydslë„ í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ select ì ˆì˜ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì§€ì›í•œë‹¤.



## Caseë¬¸

```java
@Test
void basicCase() {
    List<String> result = queryFactory
            .select(member.age
                    .when(10).then("10")
                    .when(20).then("20")
                    .otherwise("00")
            )
            .from(member)
            .fetch();

    for (String s : result) {
        System.out.println("s = " + s);
    }
}
```

```java
@Test
void complexCase() {
    List<String> result = queryFactory
            .select(
                    new CaseBuilder()
                            .when(member.age.between(0, 20)).then("0~20")
                            .when(member.age.between(21, 30)).then("21~30")
                            .otherwise("00")
            )
            .from(member)
            .fetch();

    for (String s : result) {
        System.out.println("s = " + s);
    }
}
```

## **ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°**

```java
@Test
void constant() {
    List<Tuple> result = queryFactory
            .select(member.username, Expressions.constant("A"))
            .from(member)
            .fetch();

    for (Tuple tuple : result) {
        System.out.println("tuple = " + tuple);
    }
}
```

```java
@Test
void concat() {
    List<String> result = queryFactory
            .select(member.username.concat("_").concat(member.age.stringValue()))
            .from(member)
            .where(member.username.eq("member1"))
            .fetch();

    for (String s : result) {
        System.out.println("s = " + s);
    }
}
```

ğŸ’¡ `member.age.stringValue()` ë¶€ë¶„ì´ ì¤‘ìš”í•œë°, ë¬¸ìê°€ ì•„ë‹Œ ë‹¤ë¥¸ íƒ€ì…ë“¤ì€ `stringValue()` ë¡œ
ë¬¸ìë¡œ ë³€í™˜í•  ìˆ˜ ìˆë‹¤. ì´ ë°©ë²•ì€ `ENUM`ì„ ì²˜ë¦¬í•  ë•Œë„ ìì£¼ ì‚¬ìš©í•œë‹¤.
